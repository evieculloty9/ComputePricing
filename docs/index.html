<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Price-IQ • GPU Market Dashboard (baseline)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0f1115; --panel:#151923; --muted:#9aa4b2; --text:#e8eef7; }
    *{box-sizing:border-box} body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);background:var(--bg)}
    header{padding:16px 20px;border-bottom:1px solid #1e2430;background:#0f131c;position:sticky;top:0}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    .tag{display:inline-block;padding:2px 8px;border:1px solid #2a3345;border-radius:999px;color:#cbd5e1;font-size:12px}
    .card{background:var(--panel);border:1px solid #1e2430;border-radius:12px;padding:16px;margin-top:16px}
    .error{background:#2a1120;border:1px solid #532338;color:#ffd6e0;border-radius:10px;padding:10px;display:none}
    code,pre{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px} th,td{padding:8px;border-bottom:1px solid #1f2633;text-align:left}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1 style="margin:0">Price-IQ • GPU Market Dashboard</h1>
      <span class="tag" id="badge">loading…</span>
      <span class="tag" id="rows" style="margin-left:8px">rows: —</span>
    </div>
  </header>

  <div class="wrap">
    <div id="err" class="error"></div>

    <div class="card">
      <div><strong>Fetch status</strong></div>
      <div id="status">—</div>
    </div>

    <div class="card">
      <div><strong>First row keys</strong></div>
      <pre id="keys">—</pre>
    </div>

    <div class="card">
      <div><strong>First 3 rows (pretty)</strong></div>
      <pre id="preview">—</pre>
    </div>
  </div>

  <script>
  // run after DOM + Papa are loaded
  window.addEventListener('DOMContentLoaded', async () => {
    const PATH = "data/derived/provider_scores_latest.csv";
    const $ = s => document.querySelector(s);
    const showErr = (msg) => { const el = $("#err"); el.textContent = msg; el.style.display = "block"; };

    try {
      // sanity: confirm Papa is present
      if (typeof Papa === "undefined") {
        showErr("PapaParse failed to load. Check CDN or CSP.");
        return;
      }

      // fetch with explicit diagnostics
      const res = await fetch(PATH, {cache:'no-store'});
      const text = await res.text();
      $("#status").textContent = `HTTP ${res.status} • bytes=${text.length}`;
      if (!res.ok || !text.length) {
        showErr(`Failed to fetch CSV: HTTP ${res.status}, bytes=${text.length}. Path should be docs/${PATH}.`);
        $("#badge").textContent = "loaded";
        $("#rows").textContent = "rows: 0";
        return;
      }

      // parse
      const parsed = Papa.parse(text, {header:true, dynamicTyping:false, skipEmptyLines:true});
      const rows = parsed.data || [];
      $("#badge").textContent = "loaded";
      $("#rows").textContent = `rows: ${rows.length}`;

      if (parsed.errors && parsed.errors.length) {
        console.warn("Papa errors:", parsed.errors.slice(0,3));
      }

      if (!rows.length) {
        showErr("CSV parsed successfully but contains 0 data rows (only header?).");
        return;
      }

      // Display first row keys (handles BOM)
      const first = rows[0];
      const keys = Object.keys(first);
      $("#keys").textContent = JSON.stringify(keys, null, 2);

      // Normalize a couple columns just to prove data is there
      const numify = v => {
        const s = String(v ?? "").trim();
        const x = parseFloat(s.replace(/[^\d.\-]/g, ""));
        return Number.isFinite(x) ? x : null;
      };
      const norm = rows.slice(0,3).map(r => ({
        provider: r.provider ?? r["\ufeffprovider"] ?? "",
        region: r.region ?? "",
        gpu_model: r.gpu_model ?? "",
        type: r.type ?? "",
        duration: r.duration ?? "",
        gpu_count: r.gpu_count ?? "",
        price: numify(r.effective_price_usd_per_gpu_hr ?? r.usd_per_gpu_hr ?? r.price_hourly_usd),
        timestamp: r.timestamp ?? r.asof_utc ?? ""
      }));
      $("#preview").textContent = JSON.stringify(norm, null, 2);

    } catch (e) {
      console.error(e);
      showErr("Fatal JS error: " + (e && e.message ? e.message : String(e)));
    }
  });
  </script>
</body>
</html>



